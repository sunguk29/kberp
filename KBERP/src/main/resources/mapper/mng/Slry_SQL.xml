<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="SlryMng">
	
	<select id="getSlryMngCnt" resultType="Integer" parameterType="hashmap">
		SELECT COUNT(*) AS CNT
		FROM (  SELECT S.SLRY, S.STNDR_YEAR_MONTH AS STNDR_YM, E.EMP_NAME
		        FROM EMP E INNER JOIN APNTM A
		                           ON E.EMP_NUM = A.EMP_NUM
		                   INNER JOIN RANK R
		                           ON A.RANK_NUM = R.RANK_NUM
		                   INNER JOIN DEPT D
		                           ON A.DEPT_NUM = D.DEPT_NUM
		                   INNER JOIN SLRY S
		                           ON E.EMP_NUM = S.EMP_NUM
		                   INNER JOIN BNFT B
		                           ON E.EMP_NUM = B.EMP_NUM
		                          AND S.STNDR_YEAR_MONTH = B.STNDR_YEAR_MONTH
		        GROUP BY D.DEPT_NAME, R.RANK_NAME, E.EMP_NAME, S.SLRY, S.STNDR_YEAR_MONTH  )
		WHERE TO_CHAR(STNDR_YM, 'YYYY-MM') = #{mon}
		<if test="searchTxt != null and searchTxt != ''">
			AND EMP_NAME LIKE '%' || #{searchTxt} || '%'
		</if>
	</select>
	
	<select id="getSlryMngList" resultType="hashmap" parameterType="hashmap">
		SELECT D.DEPT_NAME, R.RANK_NAME, E.EMP_NAME, E.EMP_NUM, TO_CHAR(S.SLRY, '999,999,999,999') AS SLRY, NVL(TO_CHAR(SUM(B.AMNT), '999,999,999,999'), 0) AS BNFT,
		       TO_CHAR((S.SLRY * 0.045) + (S.SLRY * 0.0343) + (S.SLRY * 0.0343 * 0.1152) + (S.SLRY * 0.008) + (S.SLRY * 0.04) + (S.SLRY * 0.04 * 0.1), '999,999,999,999') AS WH,
		       TO_CHAR((S.SLRY + NVL(SUM(B.AMNT), 0) - ((S.SLRY * 0.045) + (S.SLRY * 0.0343) + (S.SLRY * 0.0343 * 0.1152) + (S.SLRY * 0.008) + (S.SLRY * 0.04) + (S.SLRY * 0.04 * 0.1))), '999,999,999,999') AS RESULT
		FROM EMP E INNER JOIN (SELECT EMP_NUM, DEPT_NUM, RANK_NUM, END_DATE,
                                      ROW_NUMBER() OVER(PARTITION BY EMP_NUM ORDER BY APNTM_NUM DESC) AS RNUM
                               FROM APNTM
                               WHERE STS_NUM = 1) A
		                   ON E.EMP_NUM = A.EMP_NUM
                          AND A.RNUM = 1
		                  AND (A.END_DATE IS NULL OR TO_CHAR(A.END_DATE, 'YYYYMMDD') >= TO_CHAR(SYSDATE, 'YYYYMMDD'))
		           INNER JOIN DEPT D
		                   ON A.DEPT_NUM = D.DEPT_NUM
		           INNER JOIN RANK R
		                   ON A.RANK_NUM = R.RANK_NUM
		           INNER JOIN SLRY S
		                   ON E.EMP_NUM = S.EMP_NUM
		           LEFT OUTER JOIN BNFT B
		                 	    ON E.EMP_NUM = B.EMP_NUM
		                	   AND S.STNDR_YEAR_MONTH = B.STNDR_YEAR_MONTH
		WHERE TO_CHAR(S.STNDR_YEAR_MONTH, 'YYYY-MM') = #{mon}
		<if test="searchTxt != null and searchTxt != ''">
			AND E.EMP_NAME LIKE '%' || #{searchTxt} || '%'
		</if>
		GROUP BY D.DEPT_NAME, R.RANK_NAME, E.EMP_NAME, E.EMP_NUM, S.SLRY, S.STNDR_YEAR_MONTH
	</select>
	
</mapper>