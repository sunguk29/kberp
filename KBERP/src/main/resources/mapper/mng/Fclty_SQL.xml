<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Fclty">

<select id="rsvtnFcltyList" resultType="hashmap" parameterType="hashmap">
	SELECT O.RSVTN_NUM, O.FCLTY_NAME, O.RSVTN_DATE, 
       O.START_TIME, O.END_TIME,DECODE(O.STS_NUM,0,'승인대기',1,'취소된 예약',2,'승인',3,'승인거절') AS STS_NUM
	FROM        (SELECT R.RSVTN_NUM, F.FCLTY_NAME, TO_CHAR(R.RSVTN_DATE,'YYYY-MM-DD')AS RSVTN_DATE, 
                  		RT.START_TIME, RT.END_TIME, R.STS_NUM,ROW_NUMBER() OVER(ORDER BY R.RSVTN_NUM) AS RSUM,R.USE_NUM_OF_PL
            	 FROM FCLTY_RSVTN R  INNER JOIN FCLTY F 
                                ON R.FCLTY_NUM = F.FCLTY_NUM
                                INNER JOIN RSVTN_TIME_DVSN RT
                                ON R.TIME_DVSN_NUM = RT.TIME_DVSN_NUM
	             WHERE F.DEL = 0 AND STS_NUM != 1
	<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="searchGbn == 0">
					AND F.FCLTY_NAME LIKE '%' || #{searchTxt} || '%' 
				</when>
			</choose>
	</if>
	) O 
	WHERE O.RSUM BETWEEN #{startCount} AND #{endCount} 
</select>

<select id="fcltyListRqstCnt" resultType="Integer" parameterType="hashmap">
	SELECT COUNT(*) AS CNT
	FROM FCLTY_RSVTN  R INNER JOIN FCLTY F ON R.FCLTY_NUM = F.FCLTY_NUM 
	WHERE F.DEL = 0 	
	<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="searchGbn == 0">
					AND F.FCLTY_NAME LIKE '%' || #{searchTxt} || '%' 
				</when>
			</choose>
	</if>
</select>

<select id="fcltUseRqstView" resultType="hashmap" parameterType="hashmap">
	SELECT F.FCLTY_NAME,F.PLACE, TO_CHAR(R.RSVTN_DATE,'YYYY-MM-DD')AS RSVTN_DATE, 
       	   RT.START_TIME, RT.END_TIME,R.USE_NUM_OF_PL,DECODE(R.STS_NUM,0,'승인대기',1,'취소된 예약',2,'승인',3,'승인거절') AS STS_NUM,R.USE_USE
	FROM FCLTY_RSVTN R  INNER JOIN FCLTY F 
                    ON R.FCLTY_NUM = F.FCLTY_NUM
                    INNER JOIN RSVTN_TIME_DVSN RT
                    ON R.TIME_DVSN_NUM = RT.TIME_DVSN_NUM
	WHERE F.DEL = 0 AND R.RSVTN_NUM = #{no}
</select>

<select id="fcltUseRqstCncl" parameterType="hashmap">
	UPDATE FCLTY_RSVTN SET STS_NUM = 1
	WHERE RSVTN_NUM = #{no}
</select>

<select id="fcltyList" resultType="hashmap" parameterType="hashmap">
	SELECT O.FCLTY_NUM, O.FCLTY_NAME, O.PLACE, O.EMP_NAME, O.ACPT_NUM_OF_PL
	FROM( SELECT F.FCLTY_NUM, F.FCLTY_NAME, F.PLACE, E.EMP_NAME, F.ACPT_NUM_OF_PL,ROW_NUMBER() OVER(ORDER BY F.FCLTY_NUM) AS RSUM
	      FROM FCLTY F  INNER JOIN EMP E 
	      				ON F.EMP_NUM = E.EMP_NUM
	      WHERE DEL = 0 
	<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="searchGbn == 0">
					AND F.FCLTY_NAME LIKE '%' || #{searchTxt} || '%' 
				</when>
				<when test="searchGbn == 1">
					AND F.PLACE LIKE '%' || #{searchTxt} || '%' 
				</when>
			</choose>
	</if>
	     ) O 
	WHERE O.RSUM BETWEEN #{startCount} AND #{endCount} 
</select>

<select id="fcltyListCnt" resultType="Integer" parameterType="hashmap">
	SELECT COUNT(*) AS CNT
	FROM FCLTY
	WHERE DEL = 0 
	<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="searchGbn == 0">
					AND FCLTY_NAME LIKE '%' || #{searchTxt} || '%' 
				</when>
				<when test="searchGbn == 1">
					AND PLACE LIKE '%' || #{searchTxt} || '%' 
				</when>
			</choose>
	</if>
</select>

<select id="getEmpList" resultType="hashmap" parameterType="hashmap">
	SELECT O.EMP_NUM,O.EMP_NAME
	FROM       ( SELECT A.EMP_NUM,E.EMP_NAME,ROW_NUMBER() OVER(ORDER BY E.EMP_NUM DESC) AS RNUM
        		FROM DEPT D INNER JOIN APNTM A
                    		ON D.DEPT_NUM = A.DEPT_NUM
                   			INNER JOIN EMP E
                    		ON A.EMP_NUM = E.EMP_NUM
        		WHERE D.DEPT_NUM = 5 
	             <if test="sendSrchTxt != null and sendSrchTxt != ''">
	             	AND E.EMP_NAME LIKE '%' || #{sendSrchTxt} || '%'
	             </if>
	            )O
	WHERE O.RNUM BETWEEN #{startCount} AND #{endCount}
</select>

<select id="getEmpCnt" resultType="Integer" parameterType="hashmap">
	SELECT COUNT(*)
	FROM(   SELECT A.EMP_NUM,E.EMP_NAME,ROW_NUMBER() OVER(ORDER BY E.EMP_NUM DESC) AS RNUM
       		FROM DEPT D INNER JOIN APNTM A
                    ON D.DEPT_NUM = A.DEPT_NUM
                    INNER JOIN EMP E
                    ON A.EMP_NUM = E.EMP_NUM
       		WHERE D.DEPT_NUM = 5 
		<if test="sendSrchTxt != null and sendSrchTxt != ''">
			AND E.EMP_NAME LIKE '%' || #{sendSrchTxt} || '%'
		</if>
		) 
</select>

<select id="fcltyAdd" parameterType="hashmap">
	INSERT INTO FCLTY(FCLTY_NUM, EMP_NUM, MNG_EMP_NUM, FCLTY_NAME, ATT_PCTR, 
					  PLACE, ACPT_NUM_OF_PL, RMRKS)
	VALUES(FCLT_SEQ.NEXTVAL, #{empNum},#{mngEmpNum},#{fcltyName},
		   #{attFile},#{place},#{acptNum},#{rmrks})
</select>

<select id="fcltyView" resultType="hashmap" parameterType="hashmap">
	SELECT F.FCLTY_NUM, F.FCLTY_NAME ,F.PLACE, E.EMP_NAME, E2.EMP_NAME AS MNG_EMP
		  ,F.ACPT_NUM_OF_PL, TO_CHAR(F.RGSTRTN_DATE,'YYYY-MM-DD')AS RGSTRTN_DATE, F.RMRKS,F.ATT_PCTR
	FROM FCLTY F INNER JOIN EMP E 
             ON F.EMP_NUM = E.EMP_NUM
             INNER JOIN EMP E2
             ON F.MNG_EMP_NUM = E2.EMP_NUM
	WHERE FCLTY_NUM = #{no} AND DEL = 0
</select>

<select id="fcltyViewList" resultType="hashmap" parameterType="hashmap">
	SELECT O.RSVTN_NUM, O.EMP_NAME,O.RSVTN_DATE, O.START_TIME, O.END_TIME, O.USE_USE, O.USE_NUM_OF_PL,O.STS_NUM
	FROM    (SELECT FR.RSVTN_NUM, E.EMP_NAME, TO_CHAR(FR.RSVTN_DATE,'YYYY-MM-DD')AS RSVTN_DATE,RT.START_TIME, RT.END_TIME, FR.USE_USE, 
                FR.USE_NUM_OF_PL, DECODE(FR.STS_NUM,0,'승인대기',1,'예약취소',2,'승인',3,'승인거절') AS STS_NUM,
                ROW_NUMBER() OVER(ORDER BY FR.RSVTN_NUM) AS RSUM
         	 FROM FCLTY_RSVTN FR INNER JOIN RSVTN_TIME_DVSN RT
                             ON FR.TIME_DVSN_NUM = RT.TIME_DVSN_NUM
                             INNER JOIN EMP E 
                             ON FR.EMP_NUM = E.EMP_NUM
        	 WHERE FR.FCLTY_NUM = #{no} 
        	 	<if test="fSearchTxt != null and fSearchTxt != ''">
					<choose>
						<when test="fSearchGbn == 0">
							AND E.EMP_NAME LIKE '%' || #{fSearchTxt} || '%' 
						</when>
					</choose>
				</if>
        	 ) O
	WHERE O.RSUM BETWEEN #{startCount} AND #{endCount}
</select>

<select id="fcltyViewListCnt" resultType="Integer" parameterType="hashmap">
	SELECT COUNT(*) AS CNT
	FROM FCLTY_RSVTN FR INNER JOIN EMP E
	                    ON FR.EMP_NUM = E.EMP_NUM
	WHERE FCLTY_NUM = #{no}
	<if test="fSearchTxt != null and fSearchTxt != ''">
		<choose>
			<when test="fSearchGbn == 0">
					AND E.EMP_NAME LIKE '%' || #{fSearchTxt} || '%' 
			</when>
		</choose>
	</if>
</select>
</mapper>




