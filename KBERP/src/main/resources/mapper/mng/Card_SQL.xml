<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="card">

	<select id="getCnt" resultType="Integer" parameterType="hashmap">
		SELECT COUNT(*) AS CNT
		FROM CARD
		WHERE 1 = 1
		<if test="searchTxt != null and searchTxt != ''">
			<choose>
				<when test="searchGbn == 0">
					AND CARD_NUM LIKE '%' || #{searchTxt} || '%'
				</when>
				<when test="searchGbn == 1">
					AND CARD_NAME LIKE '%' || #{searchTxt} || '%'
				</when>
			</choose>
		</if>
	</select>
	 <select id="cardList" resultType="hashmap" parameterType="hashmap">
		SELECT *
		FROM (SELECT C.MNG_NUM,C.CARD_NUM, C.CARD_NAME,E.EMP_NAME AS EMP_NAME ,
		             TO_CHAR(USE_START_DT,'YYYY-MM-DD')AS USE_START_DT,
        			 TO_CHAR(USE_END_DT,'YYYY-MM-DD')AS USE_END_DT,
        			 ROW_NUMBER()OVER(ORDER BY C.CARD_NUM DESC) AS RNUM
			  FROM CARD C INNER JOIN EMP E
                                  ON C.EMP_NUM = E.EMP_NUM
                          LEFT OUTER JOIN CARD_USER CU
                                  ON C.MNG_NUM = CU.MNG_NUM
		WHERE 1=1
		<if test="searchTxt != null and searchTxt != ''"> 
					<choose>
						<when test="searchGbn == 0">
							AND CARD_NUM LIKE '%' || #{searchTxt} || '%'
						</when>
						<when test="searchGbn == 1">
							AND CARD_NAME LIKE '%' || #{searchTxt} || '%'
						</when>
					</choose>
				</if>
				) A
				WHERE A.RNUM BETWEEN #{startCount} AND #{endCount}
	</select>
	
	 <select id="cardView" resultType="hashmap" parameterType="hashmap">
		SELECT A.MNG_NUM,B.MNG_NUM
			 , A.EMP_NUM
    		 , (SELECT EMP_NAME FROM EMP Z WHERE Z.EMP_NUM =  A.EMP_NUM) AS MNG_EMP_NM
     		 , B.EMP_NUM
     		 , (SELECT EMP_NAME FROM EMP Z WHERE Z.EMP_NUM =  B.EMP_NUM) AS USE_EMP_NM
      		 , A.CARD_NUM 
     	     , A.CARD_NAME
     		 , A.CARD_DVSN
     		 , C.CARD_CMPNY_NAME
     		 , TO_CHAR(A.ISSUE_DT,'YYYY-MM-DD')AS ISSUE_DT
     		 , TO_CHAR(A.END_DT,'YYYY-MM-DD')AS END_DT
    		 ,TO_CHAR(A.DSCRD_DT,'YYYY-MM-DD')AS DSCRD_DT
 	   FROM CARD A
                LEFT JOIN CARD_USER B
                       ON A.MNG_NUM = B.MNG_NUM
                LEFT JOIN CARD_CMPNY C
                       ON A.CARD_CMPNY_NUM = C.CARD_CMPNY_NUM
       WHERE CARD_NUM = #{no}
	</select>
	
	<insert id="writeCard" parameterType="hashmap"> 
		INSERT INTO CARD(MNG_NUM,CARD_CMPNY_NUM,CARD_NAME,CARD_DVSN,CARD_NUM,NAME,EMP_NUM,ISSUE_DT,END_DT,RGSTRTN_DT)
		VALUES (CARD_SEQ.NEXTVAL,#{card_co},#{card_name},#{card_sep},#{card_code},#{use_name},#{use_num},#{issue_dt},#{end_dt},sysdate)
	</insert>
	 <select id="updateCard" resultType="hashmap" parameterType="hashmap">
	  UPDATE CARD
	     SET ISSUE_DT =#{issue_dt} ,END_DT = #{end_dt}, DSCRD_DT=#{del_dt}
	 WHERE MNG_NUM =#{mng_num}
	 </select>
	 <select id="getAllEmpCnt" resultType="Integer" parameterType="hashmap">
		SELECT COUNT(*) AS CNT
		FROM(  SELECT A.EMP_NUM, EMP_NAME,ROW_NUMBER() OVER(ORDER BY E.EMP_NUM ASC) AS RNUM,DEPT_NAME,RANK_NAME
	        		FROM DEPT D INNER JOIN APNTM A
	                    		ON D.DEPT_NUM = A.DEPT_NUM
	                   			INNER JOIN EMP E
	                    		ON A.EMP_NUM = E.EMP_NUM
                                INNER JOIN RANK R
                                ON A.RANK_NUM = R.RANK_NUM
	        		WHERE 1=1 
			<if test="sendSrchTxt != null and sendSrchTxt != ''">
				AND EMP_NAME LIKE '%' || #{sendSrchTxt} || '%'
			</if>
			) 
	</select>
	
	<select id="getAllEmpList" resultType="hashmap" parameterType="hashmap">
		SELECT EMP_NAME, DEPT_NAME, RANK_NAME, EMP_NUM
		FROM       (SELECT A.EMP_NUM, EMP_NAME,ROW_NUMBER() OVER(ORDER BY E.EMP_NUM ASC) AS RNUM,DEPT_NAME,RANK_NAME
	        		FROM DEPT D INNER JOIN APNTM A
	                    		ON D.DEPT_NUM = A.DEPT_NUM
	                   			INNER JOIN EMP E
	                    		ON A.EMP_NUM = E.EMP_NUM
                                INNER JOIN RANK R
                                ON A.RANK_NUM = R.RANK_NUM
	        		WHERE 1=1 
		             <if test="sendSrchTxt != null and sendSrchTxt != ''">
		             	AND EMP_NAME LIKE '%' || #{sendSrchTxt} || '%'
		             </if>
		            )A
		WHERE RNUM BETWEEN #{startCount} AND #{endCount}
		
	</select>
</mapper>