<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="salesRprt">
	<!-- 담당자 개수 쿼리 -->
	<select id="getMngCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM EMP E INNER JOIN APNTM A
		                           ON E.EMP_NUM = A.EMP_NUM
		                   INNER JOIN DEPT D
		                           ON A.DEPT_NUM = D.DEPT_NUM
		                   INNER JOIN RANK R
		                           ON A.RANK_NUM = R.RANK_NUM
		WHERE D.DEPT_NAME LIKE '영%'
		<choose>
			<when test="deptS != 6">
       			AND D.DEPT_NUM = #{deptS}
			</when>
		</choose>
		<if test="searchT != null and searchT != ''">
        	<choose>
       			<when test="empS == 0">
            	   AND E.EMP_NUM LIKE '%' || #{searchT} || '%'
            	</when>
       			<when test="empS == 1">
            	   AND E.EMP_NAME LIKE '%' || #{searchT} || '%'
            	</when>
        	</choose>
      	</if>
	</select>
	
	<!-- 담당자 목록 쿼리 -->
	<select id="getMngList" parameterType="hashmap" resultType="hashmap">
		SELECT ME.EMP_NUM, ME.EMP_NAME, ME.RANK_NAME, ME.DEPT_NAME
		FROM ( SELECT E.EMP_NUM, E.EMP_NAME, R.RANK_NAME, D.DEPT_NUM, D.DEPT_NAME, ROW_NUMBER() OVER(ORDER BY E.EMP_NUM ASC) AS RNUM
		        FROM EMP E INNER JOIN APNTM A
		                           ON E.EMP_NUM = A.EMP_NUM
		                   INNER JOIN DEPT D
		                           ON A.DEPT_NUM = D.DEPT_NUM
		                   INNER JOIN RANK R
		                           ON A.RANK_NUM = R.RANK_NUM
		        WHERE D.DEPT_NAME LIKE '영%'
		    ) ME
		WHERE ME.RNUM BETWEEN #{startCount} AND #{endCount}
		<choose>
			<when test="deptS != 6">
       			AND ME.DEPT_NUM = #{deptS}
			</when>
		</choose>
		<if test="searchT != null and searchT != ''">
        	<choose>
       			<when test="empS == 0">
            	   AND ME.EMP_NUM LIKE '%' || #{searchT} || '%'
            	</when>
       			<when test="empS == 1">
            	   AND ME.EMP_NAME LIKE '%' || #{searchT} || '%'
            	</when>
        	</choose>
      	</if>
	</select>
	
	<!-- 사업 형태 그래프 -->
	<select id="getSalesBsnChart" resultType="hashmap">
		SELECT A.CNT AS bsnType0, B.CNT AS bsnType1, C.CNT AS bsnType2
		FROM ( SELECT COUNT(*) AS CNT
		       FROM EXPCTD_BSNS_INFO
		       WHERE EXPCTD_BSNS_TYPE = 0) A INNER JOIN ( SELECT COUNT(*) AS CNT
		                                                FROM EXPCTD_BSNS_INFO
		                                                WHERE EXPCTD_BSNS_TYPE = 1 ) B
		                                             ON 1 = 1    
		                                     INNER JOIN ( SELECT COUNT(*) AS CNT
		                                                FROM EXPCTD_BSNS_INFO
		                                                WHERE EXPCTD_BSNS_TYPE = 2) C
		                                             ON 1 = 1
	</select>

	<!-- 당월 매출 실적 차트(내용) -->	
	<select id="getSalesRvn" resultType="hashmap">
		SELECT E.EMP_NAME AS NAME, C.MONTH_INTRST_AMNT AS RVN
		FROM SALES S INNER JOIN CNTRCT C
		                     ON S.SALES_NUM = C.SALES_NUM
		             INNER JOIN EMP E
		                     ON S.MNGR_EMP_NUM = E.EMP_NUM 
	</select>
	<!-- 당월 매출 실적 차트(상품_내용) -->	
	<select id="getSalesMdRvn" resultType="hashmap">
		SELECT M.MD_NAME AS NAME, C.MONTH_INTRST_AMNT AS RVN
		FROM CNTRCT C INNER JOIN QTN Q
		                      ON C.SALES_NUM = Q.SALES_NUM  
		                     AND Q.QTN_STS_NUM = 0
		              INNER JOIN MD M
		                      ON Q.MD_NUM = M.MD_NUM 
	</select>
	<!-- 당월 매출 실적 차트(개수) -->	
	<select id="getSalesRvnCnt" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM SALES S INNER JOIN CNTRCT C
		                     ON S.SALES_NUM = C.SALES_NUM
		             INNER JOIN EMP E
		                     ON S.MNGR_EMP_NUM = E.EMP_NUM
	</select>
	
	<!-- 영업 종료(실패) 개수 -->
	<select id="getFailCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM SALES
		WHERE SUBSTR(PRGRS_STS_NUM, 2, 1) = 6 
	</select>
	
	<!-- 영업 종료(성공) 개수 -->
	<select id="getEndCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM SALES
		WHERE SUBSTR(PRGRS_STS_NUM, 2, 1) = 5 
	</select>
	
	<!-- 영업 진행중 개수 -->
	<select id="getIngCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM SALES
		WHERE SUBSTR(PRGRS_STS_NUM, 2, 1) = 7 
	</select>
	
	<!-- 영업 전체 개수 -->
	<select id="getTotalCnt" parameterType="hashmap" resultType="Integer">
		SELECT COUNT(*) AS CNT
		FROM SALES
	</select>
</mapper>