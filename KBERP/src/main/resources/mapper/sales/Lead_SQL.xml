<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="lead">
	<select id="getLeadList" resultType="hashmap" parameterType="hashmap">
		SELECT LL.LEAD_NUM, LL.CLNT_CMPNY_NAME, LL.CLNT_NAME, LL.EMP_NAME, LL.PSNUM, LL.LEAD_NAME, LL.RGSTRTN_DATE
		FROM (  SELECT L.LEAD_NUM, CC.CLNT_CMPNY_NAME, EC.CLNT_NAME, E.EMP_NAME, L.LEAD_NAME,
		               DECODE(PRGRS_STS_NUM, 1, '진행중', 2, '종료(영업기회 전환)', 3, '종료(영업기회 실패)') AS PSNUM, 
		               TO_CHAR(L.RGSTRTN_DATE, 'YYYY-MM-DD') AS RGSTRTN_DATE, 
		               ROW_NUMBER() OVER(ORDER BY LEAD_NUM DESC) AS RNUM
		        FROM LEAD L INNER JOIN EMP E
		                            ON L.MNGR_EMP_NUM = E.EMP_NUM
		                    INNER JOIN ENTRPRS_CLNT EC
		                            ON L.CLNT_NUM = EC.CLNT_NUM
		                    INNER JOIN CLNT_CMPNY CC
		                            ON EC.CLNT_CMPNY_NUM = CC.CLNT_CMPNY_NUM ) LL
		
		WHERE LL.RNUM BETWEEN #{startCount} AND #{endCount}
	</select>
	
	<select id="getMngrList" resultType="hashmap" parameterType="hashmap">
		SELECT MNGR.EMP_NUM, MNGR.EMP_NAME, MNGR.RANK_NAME, MNGR.DEPT_NAME
		FROM ( SELECT E.EMP_NUM, E.EMP_NAME, R.RANK_NAME, D.DEPT_NUM, D.DEPT_NAME, ROW_NUMBER() OVER(ORDER BY E.EMP_NUM ASC) AS RNUM
		        FROM EMP E INNER JOIN APNTM A
		                           ON E.EMP_NUM = A.EMP_NUM
		                   INNER JOIN DEPT D
		                           ON A.DEPT_NUM = D.DEPT_NUM
		                   INNER JOIN RANK R
		                           ON A.RANK_NUM = R.RANK_NUM
		        WHERE D.DEPT_NAME LIKE '영%'
				<choose>
					<when test="deptS != 6">
		       			AND D.DEPT_NUM = #{deptS}
					</when>
				</choose>
				<if test="searchTxt != null and searchTxt != ''">
		        	<choose>
		       			<when test="empS == 0">
		            	   AND E.EMP_NUM LIKE '%' || #{searchTxt} || '%'
		            	</when>
		       			<when test="empS == 1">
		            	   AND E.EMP_NAME LIKE '%' || #{searchTxt} || '%'
		            	</when>
		        	</choose>
		      	</if> ) MNGR
		WHERE MNGR.RNUM BETWEEN #{startCount} AND #{endCount}
	</select>
	
	<select id="getMngrCnt" resultType="Integer" parameterType="hashmap">
		SELECT COUNT(*) AS CNT
		FROM EMP E INNER JOIN APNTM A
		                           ON E.EMP_NUM = A.EMP_NUM
		                   INNER JOIN DEPT D
		                           ON A.DEPT_NUM = D.DEPT_NUM
		                   INNER JOIN RANK R
		                           ON A.RANK_NUM = R.RANK_NUM
		WHERE D.DEPT_NAME LIKE '영%'
		<choose>
			<when test="deptS != 6">
       			AND D.DEPT_NUM = #{deptS}
			</when>
		</choose>
		<if test="searchTxt != null and searchTxt != ''">
        	<choose>
       			<when test="empS == 0">
            	   AND E.EMP_NUM LIKE '%' || #{searchTxt} || '%'
            	</when>
       			<when test="empS == 1">
            	   AND E.EMP_NAME LIKE '%' || #{searchTxt} || '%'
            	</when>
        	</choose>
      	</if>
	</select>
	
	<select id="getCcList" resultType="hashmap" parameterType="hashmap">
		SELECT CC.CLNT_CMPNY_NAME, CC.CLNT_CMPNY_CLSFY_NAME, CC.GRADE_NAME, CC.ADRS, CC.DTL_ADRS, CC.RD
		FROM (  SELECT CC.CLNT_CMPNY_NAME, CC.CLNT_CMPNY_CLSFY_NUM, CCC.CLNT_CMPNY_CLSFY_NAME, CCG.GRADE_NAME, CC.ADRS, CC.DTL_ADRS, CC.RGSTRTN_DATE,
		               ROW_NUMBER() OVER(ORDER BY CC.CLNT_CMPNY_NUM DESC) RNUM, TO_CHAR(CC.RGSTRTN_DATE, 'YYYY-MM-DD') RD
		        FROM CLNT_CMPNY CC INNER JOIN CLNT_CMPNY_CLSFY CCC
		                                   ON CC.CLNT_CMPNY_CLSFY_NUM = CCC.CLNT_CMPNY_CLSFY_NUM
		                           INNER JOIN CLNT_CMPNY_GRADE CCG
		                                   ON CC.GRADE_NUM = CCG.GRADE_NUM
		         WHERE 1 = 1                          
				<choose>
					<when test="cccnType != 6">
						AND CC.CLNT_CMPNY_CLSFY_NUM = #{cccnType}
					</when>
				</choose> ) CC
		WHERE CC.RNUM BETWEEN #{startCount} AND #{endCount}
	</select>
	
	<select id="getCcCnt" resultType="Integer" parameterType="hashmap">
		SELECT COUNT(*) AS CNT
		FROM CLNT_CMPNY CC INNER JOIN CLNT_CMPNY_CLSFY CCC
		                           ON CC.CLNT_CMPNY_CLSFY_NUM = CCC.CLNT_CMPNY_CLSFY_NUM
		                   INNER JOIN CLNT_CMPNY_GRADE CCG
		                           ON CC.GRADE_NUM = CCG.GRADE_NUM
		WHERE 1 = 1
		<choose>
			<when test="cccnType != 6">
				AND CC.CLNT_CMPNY_CLSFY_NUM = #{cccnType}
			</when>
		</choose>         
	</select>
	
	<select id="getLeadCnt" resultType="Integer" parameterType="hashmap">
		SELECT COUNT(*) AS CNT
		FROM LEAD
		WHERE 1 = 1
	</select>

	<insert id="getLeadAdd" parameterType="hashmap">
		INSERT INTO LEAD(LEAD_NUM, RGSTRTN_EMP_NUM, MNGR_EMP_NUM, CLNT_NUM, RCGNTN_PATH_NUM, LEAD_NAME)
		VALUES(LEAD_SEQ.NEXTVAL, #{mn}, #{mn}, #{clntName}, #{rp}, #{leadName}) 
	</insert>
</mapper>